!function(a,b,c,d){if("undefined"!=typeof _activitesDePublicationSettings){var e=c.Views.PostForm,f=a("#tmpl-activity-post-form-buttons").parent(),g=c.Views.FormAvatar,h=c.Views.WhatsNew,i="no-nav";if(a("#comments").length?(i="hide",a("#comments").before(a("<div></div>").prop("id","activites-de-publication-nav")),a("#activites-de-publication-nav").after(a("<div></div>").prop("id","bp-nouveau-activity-form").addClass(i+" comments-area"))):a(f).after(a("<div></div>").prop("id","bp-nouveau-activity-form").addClass(i+" comments-area")),a("#bp-nouveau-activity-form").after(a("<div></div>").prop("id","activites-de-publication-list").addClass(i+" comments-area")),c.Models.activite=Backbone.Model.extend({defaults:{id:0,user:0,content:"",type:""},options:{path:_activitesDePublicationSettings.versionString+"/activity/",type:"POST",data:{},dataType:"json"},sync:function(a,c,e){if(e=e||{},e.context=this,b.extend(e,this.options),b.extend(e.data,c.attributes),1===parseInt(_activitesDePublicationSettings.hideSitewide,10)&&(e.data.hidden=1),"create"===a||"update"===a)return d.apiRequest(e)}}),c.Collections.activites=Backbone.Collection.extend({model:c.Models.activite,options:{path:_activitesDePublicationSettings.versionString+"/activity/",type:"GET",data:{type:"publication_activity",primary_id:_activitesDePublicationSettings.primaryID,secondary_id:_activitesDePublicationSettings.secondaryID},dataType:"json"},sync:function(a,c,e){e=e||{},e.context=this;var f=e.data||{};if(b.extend(e,this.options),b.extend(e.data,f),1===parseInt(_activitesDePublicationSettings.hideSitewide,10)&&(e.data.hidden=1),"read"===a){var g=this,h=e.success;return e.success=function(a,c,d){if(b.isUndefined(d)||(g.totalPages=parseInt(d.getResponseHeader("X-WP-TotalPages"),10),g.totalActivities=parseInt(d.getResponseHeader("X-WP-Total"),10)),g.currentPage=e.data.page||1,h)return h.apply(this,arguments)},d.apiRequest(e)}}}),c.Views.PostForm=e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.on("ready",this.bpMentionsRefresh,this)},bpMentionsRefresh:function(){"undefined"==typeof bp_mentions&&"undefined"==typeof c.mentions||a(".bp-suggestions").bp_mentions(c.mentions.users)},postUpdate:function(a){if(a){if("keydown"===a.type&&(13!==a.keyCode||!a.ctrlKey))return a;a.preventDefault()}var d=this,e={},f=new c.Models.activite;b.each(this.$el.serializeArray(),function(a){a.name=a.name.replace("[]",""),"whats-new"===a.name?d.model.set("content",a.value):-1===b.indexOf(["aw-whats-new-submit","whats-new-post-in"],a.name)&&(b.isUndefined(e[a.name])?e[a.name]=a.value:(b.isArray(e[a.name])||(e[a.name]=[e[a.name]]),e[a.name].push(a.value)))}),this.model.set(e,{silent:!0}),f.save(b.extend(this.model.attributes,{type:"publication_activity",prime_association:_activitesDePublicationSettings.primaryID,secondary_association:_activitesDePublicationSettings.secondaryID,user:this.model.get("user_id")}),{success:function(a,e){var f=b.extend(b.first(e),{at:0});c.ActivitesDePublications.activites.add(f),b.isUndefined(c.ActivitesDePublications.activites.options.data.exclude)&&(c.ActivitesDePublications.activites.options.data.exclude=[]),c.ActivitesDePublications.activites.options.data.exclude.push(f.id),d.resetForm()},error:function(a,c){b.isUndefined(_activitesDePublicationSettings.errors[c.responseJSON.code])?d.model.set("errors",{type:"error",value:c.responseJSON.message}):d.model.set("errors",{type:"error",value:_activitesDePublicationSettings.errors[c.responseJSON.code]})}})}}),c.Views.FormAvatar=g.extend({initialize:function(){g.prototype.initialize.apply(this,arguments),this.model.get("display_avatar")&&(this.el.className="comment-author vcard")}}),c.Views.WhatsNew=h.extend({initialize:function(){this.el.placeholder=_activitesDePublicationSettings.textareaPlaceholder,h.prototype.initialize.apply(this,arguments)}}),c.Views.olderActivites=c.View.extend({tagName:"li",className:"load-more",template:c.template("plus-d-activites-de-publication")}),c.Views.navToggle=c.View.extend({tagName:"ul",template:c.template("activites-de-publication-nav"),events:{"click .nav-item a":"toggleNav"},toggleNav:function(b){b.preventDefault(),this.$el.find(".nav-item").removeClass("current"),a(b.currentTarget).parent().addClass("current"),"conversations"===a(b.currentTarget).data("type")?(a("#bp-nouveau-activity-form").removeClass("hide"),a("#activites-de-publication-list").removeClass("hide"),a("#comments").hide()):(a("#bp-nouveau-activity-form").addClass("hide"),a("#activites-de-publication-list").addClass("hide"),a("#comments").show())}}),c.Views.Activites=c.View.extend({tagName:"ol",id:"activites-liste",className:"comment-list",events:{"click .load-more a":"fetchMoreActivities"},initialize:function(){this.attachFeedback(),this.collection.on("add",this.addActiviteView,this),this.collection.on("sync",this.detachFeedback,this)},addActiviteView:function(a){var d={};b.isUndefined(a.get("at"))||(d.at=a.get("at"),a.unset("at",{silent:!0})),this.removeInfos(),this.views.add(new c.Views.Activite({model:a}),d)},attachFeedback:function(a){a=a||_activitesDePublicationSettings.loadingConversations,this.views.add(new c.Views.activityFeedback({tagName:"li",value:a,type:"info"}))},removeInfos:function(){b.each(this.views._views[""],function(a){a.type&&"info"===a.type&&a.remove()})},detachFeedback:function(a){this.removeInfos(),a.currentPage&&a.totalPages&&a.currentPage<a.totalPages&&this.views.add(new c.Views.olderActivites({model:new Backbone.Model({nextPage:a.currentPage+1})})),0===a.length&&this.attachFeedback(_activitesDePublicationSettings.noConversations)},fetchMoreActivities:function(c){c.preventDefault();var d=a(c.currentTarget).data("next-page");b.each(this.views._views[""],function(a){a.model.get("nextPage")&&a.remove()}),d&&(this.attachFeedback(),this.collection.fetch({data:{page:d,per_page:parseInt(_activitesDePublicationSettings.activitiesPerPage,10)}}))}}),c.Views.Activite=c.View.extend({tagName:"li",template:c.template("activites-de-publication"),className:"comment depth-1"}),c.ActivitesDePublications={activites:new c.Collections.activites},b.isUndefined(BP_Nouveau.activity.strings.postUpdateButton)||(BP_Nouveau.activity.strings.postUpdateButton=_activitesDePublicationSettings.publishLabel),c.ActivitesDePublications.activites.fetch({data:{page:1,per_page:parseInt(_activitesDePublicationSettings.activitiesPerPage,10)},success:function(){c.Nouveau.Activity.postForm.start()},error:function(a,b){if(b.responseJSON&&"rest_authorization_required"===b.responseJSON.code){var d=new c.Views.activityFeedback({value:_activitesDePublicationSettings.mustLogIn,type:"info"});d.inject("#activites-de-publication-list")}}}),a("#activites-de-publication-nav").length){var j=new c.Views.navToggle;j.inject("#activites-de-publication-nav")}var k=new c.Views.Activites({collection:c.ActivitesDePublications.activites});k.inject("#activites-de-publication-list")}}(jQuery,_,window.bp||{},window.wp||{});