!function(a,b,c,d){if("undefined"!=typeof _activitesDePublicationSettings){var e,f,g,h,i,j,k="no-nav",l=[];if("undefined"==typeof c.View&&(b.extend(c,b.pick(d,"Backbone","ajax","template")),c.Models=c.Models||{},c.Collections=c.Collections||{},c.Views=c.Views||{},c.View=c.Backbone.View.extend({inject:function(b){this.render(),a(b).html(this.el),this.views.ready()},prepare:function(){return!b.isUndefined(this.model)&&b.isFunction(this.model.toJSON)?this.model.toJSON():{}},prepend:function(b){this.render(),a(b).prepend(this.el),this.views.ready()}})),f=a("#tmpl-activity-post-form-buttons").length?a("#tmpl-activity-post-form-buttons").parent():a("#tmpl-activites-de-publication-nav").parent(),c.Views.PostForm&&(e=c.Views.PostForm,i=c.Views.FormAvatar,j=c.Views.WhatsNew),a("#comments").length?(k="hide",a("#comments").before(a("<div></div>").prop("id","activites-de-publication-nav")),e?(a("#activites-de-publication-nav").after(a("<div></div>").prop("id","bp-nouveau-activity-form").addClass(k+" comments-area")),g=a("#bp-nouveau-activity-form")):g=a("#activites-de-publication-nav")):e?(a(f).after(a("<div></div>").prop("id","bp-nouveau-activity-form").addClass(k+" comments-area")),g=a("#bp-nouveau-activity-form")):g=f,g.after(a("<div></div>").prop("id","activites-de-publication-list").addClass(k+" comments-area")),h=a(a("#bp-nouveau-activity-form").length?"#bp-nouveau-activity-form":"#activites-de-publication-list"),h.before(a("<div></div>").prop("id","activites-de-publication-parent").addClass(k+" comments-area")),c.Models.activite=Backbone.Model.extend({defaults:{id:0,user:0,content:"",type:""},options:{path:_activitesDePublicationSettings.versionString+"/activity/",type:"POST",data:{},dataType:"json"},sync:function(a,d,e){if(e=e||{},e.context=this,b.extend(e,this.options),b.extend(e.data,d.attributes),1===parseInt(_activitesDePublicationSettings.hideSitewide,10)&&(e.data.hidden=1),"create"===a||"update"===a)return c.apiRequest(e)},updateFavorite:function(a){var d=this.get("_links"),e=this,f=a.success;return a=a||{},a.context=this,b.extend(a,b.omit(this.options,["path","data"])),!(!d.favorite||d.favorite.length<1)&&(a.url=b.first(d.favorite).href,a.success=function(a){if(a&&e.set({favorited:b.first(a).favorited}),f)return f.apply(this,arguments)},c.apiRequest(a))}}),c.Collections.activites=Backbone.Collection.extend({model:c.Models.activite,options:{path:_activitesDePublicationSettings.versionString+"/activity/",type:"GET",data:{type:"publication_activity",primary_id:_activitesDePublicationSettings.primaryID,secondary_id:_activitesDePublicationSettings.secondaryID},dataType:"json"},sync:function(a,d,e){e=e||{},e.context=this;var f=e.data||{};if(b.extend(e,this.options),b.extend(e.data,f),1===parseInt(_activitesDePublicationSettings.hideSitewide,10)&&(e.data.hidden=1),l.length>0?e.data.exclude=l:e.data.exclude&&delete e.data.exclude,"read"===a){var g=this,h=e.success;return e.success=function(a,c,d){if(b.isUndefined(d)||(g.totalPages=parseInt(d.getResponseHeader("X-WP-TotalPages"),10),g.totalActivities=parseInt(d.getResponseHeader("X-WP-Total"),10)),g.currentPage=e.data.page||1,h)return h.apply(this,arguments)},c.apiRequest(e)}}}),e?(c.Views.PostForm=e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.options.displayedParent=c.ActivitesDePublications.parentActivites,this.options.postData=this.getActiviteDePublicationData(),this.on("ready",this.bpMentionsRefresh,this),this.options.displayedParent.on("reset",this.updatePlaceholder,this)},getActiviteDePublicationData:function(){return{type:"publication_activity",primary_item_id:_activitesDePublicationSettings.primaryID,secondary_item_id:_activitesDePublicationSettings.secondaryID,user:this.model.get("user_id")}},bpMentionsRefresh:function(){"undefined"==typeof bp_mentions&&"undefined"==typeof c.mentions||a(".bp-suggestions").bp_mentions(c.mentions.users)},postUpdate:function(a){if(a){if("keydown"===a.type&&(13!==a.keyCode||!a.ctrlKey))return a;a.preventDefault()}var d=this,e={},f=new c.Models.activite;b.each(this.$el.serializeArray(),function(a){a.name=a.name.replace("[]",""),"whats-new"===a.name?d.model.set("content",a.value):-1===b.indexOf(["aw-whats-new-submit","whats-new-post-in"],a.name)&&(b.isUndefined(e[a.name])?e[a.name]=a.value:(b.isArray(e[a.name])||(e[a.name]=[e[a.name]]),e[a.name].push(a.value)))}),this.model.set(e,{silent:!0}),f.save(b.extend(this.model.attributes,this.options.postData),{success:function(a,e){var f=b.extend(b.first(e),{at:0});c.ActivitesDePublications.activites.add(f),l.push(f.id),d.resetForm()},error:function(a,c){b.isUndefined(_activitesDePublicationSettings.errors[c.responseJSON.code])?d.model.set("errors",{type:"error",value:c.responseJSON.message}):d.model.set("errors",{type:"error",value:_activitesDePublicationSettings.errors[c.responseJSON.code]})}})},updatePlaceholder:function(c){var d;if(c.models&&1===c.models.length){var e=b.first(c.models),f=e.get("id");b.extend(this.options.postData,{type:"activity_comment",primary_item_id:f,secondary_item_id:f}),d=_activitesDePublicationSettings.textareaPlaceholderAlt.replace("%s",e.get("user_name"))}else this.options.postData=this.getActiviteDePublicationData(),d=_activitesDePublicationSettings.textareaPlaceholder;b.each(this.views._views[""],function(b){"whats-new-content"===a(b.el).prop("id")&&a(b.el).find('textarea[name="whats-new"]').prop("placeholder",d)})}}),c.Views.FormAvatar=i.extend({initialize:function(){i.prototype.initialize.apply(this,arguments),this.model.get("display_avatar")&&(this.el.className="comment-author vcard")}}),c.Views.WhatsNew=j.extend({initialize:function(){this.el.placeholder=_activitesDePublicationSettings.textareaPlaceholder,j.prototype.initialize.apply(this,arguments)}})):c.Views.activityFeedback=c.View.extend({tagName:"div",id:"message",template:c.template("activity-post-form-feedback"),initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",b.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bp-messages bp-feedback "+this.type}}),c.Views.olderActivites=c.View.extend({tagName:"li",className:"load-more",template:c.template("plus-d-activites-de-publication")}),c.Views.navToggle=c.View.extend({tagName:"ul",template:c.template("activites-de-publication-nav"),events:{"click .nav-item a":"toggleNav"},initialize:function(){this.on("ready",this.setActiveListViews,this)},toggleNav:function(b){b.preventDefault(),this.$el.find(".nav-item").removeClass("current"),a(b.currentTarget).parent().addClass("current"),"conversations"===a(b.currentTarget).data("type")?(a("#bp-nouveau-activity-form").removeClass("hide"),a("#activites-de-publication-list").removeClass("hide"),a("#activites-de-publication-parent").removeClass("hide"),a("#comments").hide()):(a("#bp-nouveau-activity-form").addClass("hide"),a("#activites-de-publication-list").addClass("hide"),a("#activites-de-publication-parent").addClass("hide"),a("#comments").show())},setActiveListViews:function(){var b=this.$el.find("li.current a").data("type");"comments"!==b&&(a("#bp-nouveau-activity-form").removeClass("hide"),a("#activites-de-publication-list").removeClass("hide"),a("#activites-de-publication-parent").removeClass("hide"),a("#comments").hide())}}),c.Views.Activites=c.View.extend({tagName:"ol",id:"activites-liste",className:"comment-list",events:{"click .load-more a":"fetchMoreActivities"},initialize:function(){this.attachFeedback(),this.collection.on("add",this.addActiviteView,this),this.collection.on("sync",this.detachFeedback,this),this.collection.on("reset",this.resetQuery,this)},addActiviteView:function(a){var d={};b.isUndefined(a.get("at"))||(d.at=a.get("at"),a.unset("at",{silent:!0})),this.removeInfos(),this.views.add(new c.Views.Activite({model:a,parents:this.options.parents}),d)},attachFeedback:function(a){a=a||_activitesDePublicationSettings.loadingConversations,this.views.add(new c.Views.activityFeedback({tagName:"li",value:a,type:"info"}))},removeInfos:function(){b.each(this.views._views[""],function(a){a.type&&"info"===a.type&&a.remove()})},removePaginationLink:function(){b.each(this.views._views[""],function(a){a.model.get("nextPage")&&a.remove()})},detachFeedback:function(a){if(this.removeInfos(),a.currentPage&&a.totalPages&&a.currentPage<a.totalPages&&this.views.add(new c.Views.olderActivites({model:new Backbone.Model({nextPage:a.currentPage+1})})),0===a.length){var d=_activitesDePublicationSettings.noConversations;b.isUndefined(a.options.data.type)||"activity_comment"!==a.options.data.type||(d=_activitesDePublicationSettings.noReplies),this.attachFeedback(d)}},fetchMoreActivities:function(b){b.preventDefault();var c=a(b.currentTarget).data("next-page");this.removePaginationLink(),c&&(this.attachFeedback(),this.collection.fetch({data:{page:c,per_page:parseInt(_activitesDePublicationSettings.activitiesPerPage,10),display_comments:!0}}))},resetQuery:function(a,c){var d={page:1,per_page:parseInt(_activitesDePublicationSettings.activitiesPerPage,10),display_comments:!0};this.removePaginationLink(),c.parent&&null!==c.parent?(this.attachFeedback(_activitesDePublicationSettings.loadingReplies),b.extend(d,{type:"activity_comment",primary_id:c.parent,secondary_id:c.parent})):(this.attachFeedback(_activitesDePublicationSettings.loadingConversations),b.extend(d,{type:"publication_activity",primary_id:_activitesDePublicationSettings.primaryID,secondary_id:_activitesDePublicationSettings.secondaryID})),l=[],a.fetch({data:d})}}),c.Views.parentActivite=c.Views.Activites.extend({id:"parent-activite",initialize:function(){this.collection.on("reset",this.showParentActivite,this)},showParentActivite:function(a){a.models.length&&this.views.add(new c.Views.Activite({model:b.first(a.models),children:this.options.children}))}}),c.Views.Activite=c.View.extend({tagName:"li",template:c.template("activites-de-publication"),className:"comment depth-1",events:{"click .activite-de-publication-action":"fetchActivityComments","click .activite-de-publication-favorite":"favUnfav","click #back-to-all-activites-de-publication":"backToAllActivites"},initialize:function(){this.model.collection.on("reset",this.cleanView,this),this.on("ready",this.scrollTo,this)},fetchActivityComments:function(b){b.preventDefault();var d=this.model.clone(),e=a(b.currentTarget).data("action");d.set({parentActivite:!0},{silent:!0}),this.options.parents.reset([d],{action:e}),this.model.collection?this.model.collection.reset(null,{parent:this.model.get("id")}):c.ActivitesDePublications.activites.reset(null,{parent:this.model.get("id")})},favUnfav:function(a){a.preventDefault();var b=this;b.model.get("favoriting")||(b.model.set({favoriting:!0},{silent:!0}),this.model.updateFavorite({success:function(){b.model.unset("favoriting",{silent:!0}),b.render()}}))},cleanView:function(){this.views.view.remove()},backToAllActivites:function(a){a.preventDefault(),this.model.collection.reset(null),this.options.children.reset(null,{parent:null})},scrollTo:function(){if(this.options.children){var b=a("#activites-de-publication-parent").offset().top;a("#wpadminbar").length&&(b-=a("#wpadminbar").height()),window.scrollTo(0,b)}}}),c.ActivitesDePublications={activites:new c.Collections.activites,parentActivites:new c.Collections.activites},b.isUndefined(BP_Nouveau.activity.strings.postUpdateButton)||(BP_Nouveau.activity.strings.postUpdateButton=_activitesDePublicationSettings.publishLabel),a("#activites-de-publication-nav").length){var m=new c.Views.navToggle;m.inject("#activites-de-publication-nav")}var n=new c.Views.Activites({collection:c.ActivitesDePublications.activites,parents:c.ActivitesDePublications.parentActivites});n.inject("#activites-de-publication-list");var o=new c.Views.parentActivite({collection:c.ActivitesDePublications.parentActivites,children:c.ActivitesDePublications.activites});o.inject("#activites-de-publication-parent"),c.ActivitesDePublications.activites.fetch({data:{page:1,per_page:parseInt(_activitesDePublicationSettings.activitiesPerPage,10),display_comments:!0},success:function(){if(e)c.Nouveau.Activity.postForm.start();else{var a=new c.Views.activityFeedback({value:_activitesDePublicationSettings.mustLogIn,type:"info"});a.prepend("#activites-de-publication-list")}}})}}(jQuery,_,window.bp||{},window.wp||{});